global
    daemon
    maxconn 4096
    log stdout local0 info
    tune.ssl.default-dh-param 2048

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option tcplog
    log global
    retries 3
    option redispatch

# CQL Load Balancer - Primary Datacenter
frontend cassandra_frontend
    bind *:9142
    mode tcp
    option tcplog
    default_backend cassandra_primary

# Primary datacenter backend (DC1)
backend cassandra_primary
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    
    # Primary datacenter nodes (DC1)
    server dc1-node1 cassandra-dc1-node1:9042 check inter 5000ms rise 2 fall 3 weight 100
    server dc1-node2 cassandra-dc1-node2:9042 check inter 5000ms rise 2 fall 3 weight 100
    server dc1-node3 cassandra-dc1-node3:9042 check inter 5000ms rise 2 fall 3 weight 100
    
    # Secondary datacenter nodes (DC2) - backup with lower weight
    server dc2-node1 cassandra-dc2-node1:9042 check inter 5000ms rise 2 fall 3 weight 50 backup
    server dc2-node2 cassandra-dc2-node2:9042 check inter 5000ms rise 2 fall 3 weight 50 backup

# Read-only backend for analytics (prefers DC2 for read replicas)
frontend cassandra_readonly_frontend
    bind *:9143
    mode tcp
    option tcplog
    default_backend cassandra_readonly

backend cassandra_readonly
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    
    # Secondary datacenter nodes (DC2) - preferred for reads
    server dc2-node1 cassandra-dc2-node1:9042 check inter 5000ms rise 2 fall 3 weight 100
    server dc2-node2 cassandra-dc2-node2:9042 check inter 5000ms rise 2 fall 3 weight 100
    
    # Primary datacenter nodes (DC1) - backup for reads
    server dc1-node1 cassandra-dc1-node1:9042 check inter 5000ms rise 2 fall 3 weight 50 backup
    server dc1-node2 cassandra-dc1-node2:9042 check inter 5000ms rise 2 fall 3 weight 50 backup
    server dc1-node3 cassandra-dc1-node3:9042 check inter 5000ms rise 2 fall 3 weight 50 backup

# Disaster recovery backend (DC3)
frontend cassandra_dr_frontend
    bind *:9144
    mode tcp
    option tcplog
    default_backend cassandra_dr

backend cassandra_dr
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    
    # Backup datacenter node (DC3)
    server dc3-node1 cassandra-dc3-node1:9042 check inter 10000ms rise 3 fall 5 weight 100

# HAProxy statistics
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:password123

# Health check endpoint
listen health_check
    bind *:8405
    mode http
    monitor-uri /health
    option httplog
